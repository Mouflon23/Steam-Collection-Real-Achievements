(function(){"use strict";const c=window.SteamDB,oe=!!document.querySelector(".header-user-avatar")?175:300,T=new Map,s=document.getElementById("js-hover");if(!s)return;const k=".app";let A=null,u=null,E=null,m=null,b=null,Q=!0,x=null,g=null;const h=document.querySelector("#js-screenshots"),V=document.body.dataset.storeAssets,D=new Image;D.fetchpriority="low";let a=null,q=0,f=0;c.RequirePageScreenshotViewer(ne,!0),ie(),s.parentNode.addEventListener("click",re),s.addEventListener("pointerenter",ae,{passive:!0}),s.addEventListener("pointerleave",de,{passive:!0}),document.body.addEventListener("touchstart",se,{passive:!0}),c.BindHover=e=>J(e.querySelectorAll(k)),c.HideHoverIfAny=p,c.OnExtensionUserdataLoaded(()=>{Q=!1});function re(e){e.target.classList.contains("hover_mobile")&&(document.documentElement.classList.remove("js-hover-shown"),s.parentNode.classList.add("hover_hiding"),s.parentNode.addEventListener("transitionend",p,{once:!0}))}let y=null,w=null,d=null,W=!1,G=0;function se(e){if(e.touches.length!==1)return;const t=e.target.closest(".app, #js-hover");if(t){if(W=t.id==="js-hover",W)G=Date.now(),t.classList.add("hover_dragging");else{const n=z(t);if(n!==null&&n.scrollLeft!==0)return}d=t,y=w=e.touches.item(0),document.body.addEventListener("touchmove",K,{passive:!0}),document.body.addEventListener("touchend",I,{passive:!0})}}function K(e){const t=e.touches.item(0),n=t.screenX-y.screenX,o=t.screenY-y.screenY;if(W){w=t,s.scrollTop<1?d.style.transform=`translate3d(0, ${Math.max(0,o)}px, 0)`:y=t;return}if(t.screenX<w.screenX||Math.abs(o/n)>=.3){d=null,I();return}w=t}function I(){if(document.body.removeEventListener("touchmove",K),document.body.removeEventListener("touchend",I),d!==null){if(W){d.classList.remove("hover_dragging");const e=w.screenY-y.screenY,t=s.offsetHeight;e>t/2||Date.now()-G<180&&e>50?(document.documentElement.classList.remove("js-hover-shown"),s.parentNode.classList.add("hover_hiding"),d.style.transform=`translate3d(0, ${Math.max(0,t)}px, 0)`,d.addEventListener("transitionend",function(){p(),this.style.transform=""},{once:!0})):d.style.transform="";return}if(w.screenX-y.screenX>100){const e="app",t=+d.dataset.appid;let n;if(e==="app"&&(n=T.get(t)),n)return s.appendChild(n),_(n,null);ee(e,t,null)}d=null}}function z(e,t){return e===null||t>8?null:e.scrollWidth>e.clientWidth?e:z(e.parentNode,t+1)}function ie(){const e=typeof $=="function"&&typeof $.fn=="object"&&typeof $.fn.dataTable=="function";let t=e?[]:document.querySelectorAll(k);e&&$($.fn.dataTable.tables()).each(function(){t=$(this).DataTable().table().rows(k).nodes().reduce(function(o,r){return o.push(r),o},t),$(this).on("draw.dt",p)}),J(t)}function J(e){for(const t of e)t.addEventListener("pointerenter",Z,{passive:!0}),t.addEventListener("pointerleave",le,{passive:!0})}function Z(e){if(e.pointerType!=="mouse"||window.matchMedia("(max-width: 980px)").matches)return;if(u){E=e;return}const t="app",n=+e.target.dataset.appid;let o;if(t==="app"&&(o=T.get(n)),o)return s.appendChild(o),_(o,e.target);p(),A=setTimeout(()=>{ee(t,n,e.target)},oe)}function ee(e,t,n){let o;e==="app"&&(o=`/api/RenderAppHover/?appid=${t}`),m=new AbortController,fetch(o,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"},signal:m.signal}).then(r=>{if(!r.ok){const i=new Error(`HTTP ${r.status}`);throw i.name="ServerError",i}return r.text()}).then(r=>{m=null,s.insertAdjacentHTML("beforeend",r);const i=s.firstChild;if(i){if(e==="app"){T.set(t,i),ue(t,i);const l=i.querySelector(".js-open-screenshot-viewer");if(l&&l.dataset.screenshots){const H=l.dataset.screenshots.split(","),N=i.querySelector(".hover_title").textContent;ne(l.dataset.appid,N,l,H)}}_(i,n)}}).catch(r=>{if(!(r.name==="AbortError"||r.name==="ServerError"))throw r})}function p(){if(E=null,A&&(clearTimeout(A),A=null),u&&(clearTimeout(u),u=null),m&&(m.abort(),m=null),x&&(x.destroy(),x=null),b){s.scrollTop=0,s.hidden=!0,s.style.transform="",s.parentNode.classList.remove("hover_mobile","hover_hiding"),document.documentElement.classList.remove("js-hover-shown");const e=b.querySelector("video");e&&(e.src="",e.remove()),b.remove(),b=null}}function le(e){e.pointerType==="mouse"&&(E=null,!u&&(s.contains(e.relatedTarget)||(u=setTimeout(ce,100))))}function ce(){const e=E;p(),e&&Z(e)}function ae(){clearTimeout(u),u=null,E=null}function de(e){e.pointerType==="mouse"&&p()}function _(e,t){const n=e.querySelector(".hover_video");if(n){const v=document.createElement("video");v.autoplay=!0,v.muted=!0,v.loop=!0,v.playsInline=!0;let Y=n.dataset.src;v.canPlayType('video/webm; codecs="vp8, vorbis"')!=="probably"&&(Y=Y.replace(/\.webm$/,".mp4")),v.src=Y,n.appendChild(v)}if(t===null&&(s.parentNode.classList.add("hover_mobile"),document.documentElement.classList.add("js-hover-shown"),"CloseWatcher"in window&&(x=new window.CloseWatcher,x.addEventListener("close",p))),b=e,s.hidden=!1,t===null)return;const o=t.getBoundingClientRect(),r=document.documentElement.scrollTop,i=o.top+r,l=o.bottom+r,H=o.left+document.documentElement.scrollLeft,N=document.documentElement.clientWidth,P=document.documentElement.clientHeight,U=s.offsetWidth,C=s.offsetHeight,he=N-(H+o.width+U),F=H-U;let L=0;F<0&&he<0?(s.style.left=o.right-U+"px",i+C>P+r&&i-C>=r?L=i-C:L=l):(F<0?s.style.left=H+o.width+"px":s.style.left=F+"px",i+C>P+r?L=P+r-C:L=i),L<1?s.style.top=0:s.style.top=L+"px"}function S(e){f+=e,f<0?f=a.length-1:f%=a.length;let t=a[f];if(t.startsWith("https://")||(t=`${V}apps/${q}/${t}`),h.querySelector(".screenshot-contain").style.backgroundImage=`url(${encodeURI(t)})`,h.querySelector(".screenshot-index").textContent=`${f+1} of ${a.length}`,h.querySelector(".screenshot-open").href=t,a.length>1){e===0&&(e=1);let n=f+e;n<0?n=a.length-1:n%=a.length,t=a[n],t.startsWith("https://")||(t=`${V}apps/${q}/${t}`),D.src=t}}function te(e){e.key==="ArrowLeft"?(e.preventDefault(),S(-1)):e.key==="ArrowRight"||e.key===" "?(e.preventDefault(),S(1)):e.key==="Escape"&&g===null&&(e.preventDefault(),O())}function O(){document.documentElement.classList.remove("js-screenshots-shown"),document.removeEventListener("keydown",te),a=null,D.src="/static/p.gif",g&&(g.destroy(),g=null)}h.querySelector(".screenshot-prev").addEventListener("click",e=>{e.preventDefault(),S(-1)}),h.querySelector(".screenshot-next").addEventListener("click",e=>{e.preventDefault(),S(1)}),h.querySelector(".screenshot-close").addEventListener("click",e=>{e.preventDefault(),O()}),h.querySelector(".screenshot-contain").addEventListener("click",e=>{e.preventDefault(),S(e.pageX/document.documentElement.clientWidth>=.5?1:-1)});function ne(e,t,n,o){const r=i=>{const l=h.querySelector(".screenshot-name");l.textContent=`SteamDB \u2014 ${t}`,l.href=`/app/${e}/`,f=i,q=e,a=o,S(0),document.documentElement.classList.add("js-screenshots-shown"),document.addEventListener("keydown",te),"CloseWatcher"in window&&(g=new window.CloseWatcher,g.addEventListener("close",O))};return n&&n.addEventListener("click",i=>{i.preventDefault(),r(0)}),{open:r}}function ue(e,t){if(Q)return;const n=t.querySelector(".hover_wishlist"),o=t.querySelector(".hover_follow"),r=t.querySelector(".hover_ignore"),i=t.querySelector(".hover_owned");c.OwnedApps.has(e)?i.hidden=!1:(c.FamilySharedApps.has(e)&&(i.textContent="In Family Library",i.classList.add("infamily"),i.hidden=!1),n&&(c.WishedApps.has(e)&&M(n,!0),n.hidden=!1,n.addEventListener("click",l=>{l.preventDefault(),j(n),B(e,c.WishedApps.has(e)?"StoreWishlistRemove":"StoreWishlistAdd")}))),o&&(c.FollowedApps.has(e)&&R(o,!0),o.hidden=!1,o.addEventListener("click",l=>{l.preventDefault(),j(o),B(e,c.FollowedApps.has(e)?"StoreUnfollow":"StoreFollow")})),r&&(c.IgnoredApps.has(e)&&X(r,!0),r.hidden=!1,r.addEventListener("click",l=>{l.preventDefault(),j(r),B(e,c.IgnoredApps.has(e)?"StoreUnignore":"StoreIgnore")}))}function j(e){e.innerHTML='<span class="loader"></span>'}function B(e,t){window.postMessage({type:"steamdb:extension-query",contentScriptQuery:t,appid:e},window.location.origin)}function M(e,t){e&&(e.classList.toggle("wished",t),e.textContent=t?"On Wishlist":"Wishlist")}function R(e,t){e&&(e.classList.toggle("followed",t),e.textContent=t?"Unfollow":"Follow")}function X(e,t){e&&(e.classList.toggle("ignored",t),e.textContent=t?"Unignore":"Ignore")}if("BroadcastChannel"in window)try{new BroadcastChannel("steamdb-extension").addEventListener("message",t=>{if(!(!t||t.origin!==window.location.origin)&&t.data&&t.data.type==="steamdb:extension-response"){if(!t.data.response||!t.data.response.success||!t.data.request.appid)return;const n=T.get(t.data.request.appid);if(!n)return;const o=n.querySelector(".hover_wishlist"),r=n.querySelector(".hover_follow"),i=n.querySelector(".hover_ignore");switch(t.data.request.contentScriptQuery){case"StoreWishlistAdd":M(o,!0);break;case"StoreWishlistRemove":M(o,!1);break;case"StoreFollow":R(r,!0);break;case"StoreUnfollow":R(r,!1);break;case"StoreIgnore":X(i,!0);break;case"StoreUnignore":X(i,!1);break}}})}catch{}})();
