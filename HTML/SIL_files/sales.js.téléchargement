(function(){"use strict";const r=window.SteamDB;function _(e){const t=document.querySelector("#js-filter-loader h3");t.textContent="An error has occured.",t.insertAdjacentText("afterend",e.message),document.querySelector("#js-filter-loader .loader").hidden=!0}function L(){document.getElementById("js-filter-loader").hidden=!1,document.getElementById("js-app").hidden=!0}window.addEventListener("error",_),TimeAgo.cssTooltip=!1,TimeAgo.datetime=function(e){return new Date($(e).attr("data-sort")*1e3)};let u=null;const P=$("#js-select-tags").multipleSelect({placeholder:"Filter by user tags",countSelected:"# of % user tags",filter:!0,onClick(e){const t=$(e),s=t.val();t.prop("checked")?s[0]!=="-"&&t.parent().find(".octicon-diff-added").addClass("tag-on"):(t.parent().find(".tag-on").removeClass("tag-on"),s[0]==="-"&&t.val(s.substring(1)))}}),ae=P.data("multipleSelect"),ie=$(`<label class="steamy-checkbox-control"><input type="checkbox" id="js-match-all-tags"${P.data("match")!=="all"?"":" checked"}><span>Match all included tags</span></label>`);ae.$drop.find(".ms-search").after(ie);const re=$("#js-select-categories").multipleSelect({placeholder:"Filter by features",countSelected:"# of % features",filter:!0,onClick(e){const t=$(e),s=t.val();t.prop("checked")?s[0]!=="-"&&t.parent().find(".octicon-diff-added").addClass("tag-on"):(t.parent().find(".tag-on").removeClass("tag-on"),s[0]==="-"&&t.val(s.substring(1)))}});$(".fancy-select").on("click","label .octicon-diff-removed",function(){const e=$(this),t=e.parent().parent(),s=t.find("input"),n=s.val();n[0]!=="-"&&(t.find(".octicon-diff-added").removeClass("tag-on"),e.addClass("tag-on"),s.val("-"+n).prop("checked",!1))});const le=$("#js-select-type").multipleSelect({single:!0}),ce=$("#js-select-os").multipleSelect({single:!0}),de=$("#js-select-cc").multipleSelect({single:!0,filter:!0});let E,H;const ue=e=>{const t=document.body.dataset.storeAssets;let s;const n=function(a){a.find(".timeago").each(function(){TimeAgo.init(this)});const i=a[0];let c;i.classList.contains("package")?c=`${t}subs/${i.dataset.subid}/capsule_231x87.jpg?t=${i.dataset.cache}`:c=`${t}apps/${i.dataset.appid}/${i.dataset.capsule}`,a.find(".applogo img").attr("decoding","async").attr("src",c)},o=function(){s=0;const a=(window.innerHeight||document.documentElement.clientHeight)+80,i=[];for(const c of e){const f=c.getBoundingClientRect();f.top>-80&&f.bottom<a&&f.bottom>0&&i.push(c)}for(const c of i)n($(c));e=e.not(i)};H=()=>{clearTimeout(s),o()},E=()=>{s||(s=setTimeout(o,100))},window.addEventListener("scroll",E,{passive:!0}),window.addEventListener("resize",E,{passive:!0})};$(".applogo img").one("error",function(){$(this).attr("src","/static/img/applogo.svg")}),ue($(".app, .package"));const pe=$("#js-sales-count"),d=$("#js-filters"),U=d.data("pageType"),I=U==="sales",l=I?"sales":"special",B=document.querySelector(".current-sale-filters-contain"),x=document.querySelector(".current-sale-filters"),N=B.querySelector("#js-remove-svg > svg");N.parentNode.remove(),x.querySelectorAll(".sale-filter > button").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),L();const s=e.dataset.id,n=new URLSearchParams(location.search);I&&(s==="min_discount"||s==="min_rating"||s==="min_reviews")?n.set(s,"0"):n.delete(s),n.sort(),location.search=n.toString()})});function p(e,t,s){if(!s){x.querySelector(`span[data-id="${e}"]`)?.remove(),x.childElementCount===0&&(B.hidden=!0);return}const n=document.createElement("span");n.className="sale-filter",n.dataset.id=e,n.textContent=t;const o=document.createElement("button");o.type="button",o.append(N.cloneNode(!0)),n.append(o),x.append(n),o.addEventListener("click",a=>{a.preventDefault(),document.getElementById(e).click()}),B.hidden=!1}let h;const k=$("#js-wishlisted-only");function W(){p(k.attr("id"),"Wishlisted",h)}k.on("change",function(e){e.stopImmediatePropagation(),h=this.checked,W(),h?r.Storage.Set(l+"-wishlisted-only",1):r.Storage.Remove(l+"-wishlisted-only"),u.draw()});let w;const A=$("#js-followed-only");function M(){p(A.attr("id"),"Followed",w)}A.on("change",function(e){e.stopImmediatePropagation(),w=this.checked,M(),w?r.Storage.Set(l+"-followed-only",1):r.Storage.Remove(l+"-followed-only"),u.draw()});let y;function z(){p(Y.attr("id"),"Historical lows",y)}const Y=$("#js-discounts-blue").on("change",function(e){e.stopImmediatePropagation(),y=this.checked,z(),y?r.Storage.Set(l+"-blue-discounts-only",1):r.Storage.Remove(l+"-blue-discounts-only"),u.draw()});let S;function V(){p(J.attr("id"),"Matching lows",S)}const J=$("#js-discounts-green").on("change",function(e){e.stopImmediatePropagation(),S=this.checked,V(),S?r.Storage.Set(l+"-green-discounts-only",1):r.Storage.Remove(l+"-green-discounts-only"),u.draw()});let v;function K(){p(Q.attr("id"),"2-year lows",v)}const Q=$("#js-discounts-minor").on("change",function(e){e.stopImmediatePropagation(),v=this.checked,K(),v?r.Storage.Set(l+"-minor-discounts-only",1):r.Storage.Remove(l+"-minor-discounts-only"),u.draw()});let T;const j=$("#js-hide-owned-games");function X(){p(j.attr("id"),"Hide owned",T)}j.on("change",function(e){e.stopImmediatePropagation(),T=this.checked,X(),T?r.Storage.Set(l+"-hide-owned-games",1):r.Storage.Remove(l+"-hide-owned-games"),u.draw()});let C;const O=$("#js-hide-ignored-games");function Z(){p(O.attr("id"),"Hide ignored",C)}O.on("change",function(e){e.stopImmediatePropagation(),C=this.checked,Z(),C?r.Storage.Set(l+"-hide-ignored-games",1):r.Storage.Remove(l+"-hide-ignored-games"),u.draw()});let b;const R=$("#js-hide-wishlisted");function ee(){p(R.attr("id"),"Hide wished and followed",b)}R.on("change",function(e){e.stopImmediatePropagation(),b=this.checked,ee(),b?r.Storage.Set(l+"-hide-wished",1):r.Storage.Remove(l+"-hide-wished"),u.draw()});const fe=()=>{k.removeAttr("disabled").parent().removeClass("tooltipped"),A.removeAttr("disabled").parent().removeClass("tooltipped"),j.removeAttr("disabled").parent().removeClass("tooltipped"),O.removeAttr("disabled").parent().removeClass("tooltipped"),R.removeAttr("disabled").parent().removeClass("tooltipped"),k.length>0&&r.Storage.Get(l+"-wishlisted-only")&&(k.attr("checked",""),h=!0,W()),r.Storage.Get(l+"-followed-only")&&(A.attr("checked",""),w=!0,M()),r.Storage.Get(l+"-hide-ignored-games")&&(O.attr("checked",""),C=!0,Z()),r.Storage.Get(l+"-hide-wished")&&(R.attr("checked",""),b=!0,ee()),u.rows(".package").every(function(){let e=!I;const t=this,s=t.node(),n=s.dataset.apps.split(",");delete s.dataset.apps;for(const o of n){const a=Number(o);if(r.FollowedApps.has(a)&&s.classList.add("followed"),r.WishedApps.has(a)&&(s.classList.add("wished"),!e)){e=!0;const i=this.cell(t,0),c=i.node();c.dataset.sort=Number(c.dataset.sort)+9,i.invalidate()}r.IgnoredApps.has(a)&&s.classList.add("ignored")}return!0}),I&&u.rows(".app").every(function(){const e=this,t=e.node(),s=Number(t.dataset.appid);let n=0;if(r.WishedApps.has(s)?t.querySelector(".highest-discount-major")?n=30:t.querySelector(".highest-discount")?n=20:n=10:r.OwnedApps.has(s)&&(n=-5),n!==0){const o=this.cell(e,0),a=o.node();a.dataset.sort=Number(a.dataset.sort)+n,o.invalidate()}return!0}),u.draw()};j.length>0&&r.Storage.Get(l+"-hide-owned-games")&&(j.attr("checked",""),T=!0,X()),r.Storage.Get(l+"-blue-discounts-only")&&(Y.attr("checked",""),y=!0,z()),r.Storage.Get(l+"-green-discounts-only")&&(J.attr("checked",""),S=!0,V()),r.Storage.Get(l+"-minor-discounts-only")&&(Q.attr("checked",""),v=!0,K()),$.fn.dataTableExt.afnFiltering.push(function(e,t,s){const n=e.aoData[s].nTr;if(y||S||v){const o=!!n.querySelector(".price-discount-major"),a=!!n.querySelector(".price-discount-minor"),i=!!n.querySelector(".price-discount"),c=(o?1:0)|(i?2:0)|(a?4:0),f=(y?1:0)|(S?2:0)|(v?4:0);if(!(c&f))return!1}if(h||w||b){const o=n.classList.contains("wished"),a=n.classList.contains("followed");if(b){if(o||a)return!1}else if(!o&&!a||h!==o&&w!==a)return!1}return!(C&&n.classList.contains("ignored")||T&&n.classList.contains("owned"))}),d.on("submit",function(){U!=="sales"&&(d.find("#js-input-discount, #js-input-rating").filter(function(a,i){return i.value===i.min}).prop("disabled",!0),d.find('input[name="min_reviews"]').filter(function(a,i){return i.value<=0}).prop("disabled",!0),d.find('input[name="min_followers"], input[name="max_followers"]').filter(function(a,i){return i.value<=0}).prop("disabled",!0)),d.find('.fancy-price-input, .fancy-date-input, input[name="max_reviews"]').filter(function(a,i){return i.value<=0}).prop("disabled",!0);const e=[de,le,ce];for(const a of e){const i=a.multipleSelect("getSelects");i.length>0&&i[0]!=a.data("default")&&$("<input>").attr({type:"hidden",name:a.attr("name"),value:i[0]}).appendTo(d)}const t=P.prop("disabled",!0).multipleSelect("getSelects");t.length>0&&($("<input>").attr({type:"hidden",name:"tagid",value:t.join(",")}).appendTo(d),$("#js-match-all-tags").is(":checked")||$("<input>").attr({type:"hidden",name:"any_tag",value:"1"}).appendTo(d));const s=re.prop("disabled",!0).multipleSelect("getSelects");s.length>0&&$("<input>").attr({type:"hidden",name:"category",value:s.join(",")}).appendTo(d),d.find(".fancy-price-input:not(:disabled)").length>0&&d.find("#js-select-cc").prop("disabled",!1);const n=d.find("#js-select-type").val();n!=="Watched"&&n!=="OwnedGames"&&n!=="OwnedGamesDLC"&&n!=="AllOwnedGamesDLC"&&d.find('input[name="accountid"]').prop("disabled",!0);const o=new URLSearchParams(location.search).get("sort");if(o&&$("<input>").attr({type:"hidden",name:"sort",value:o}).appendTo(d),L(),d.serialize().length===0)return window.location.href=window.location.pathname,!1}).find("select, input").one("change",function(){$("#js-filter-submit").prop("disabled",!1)}),$("#js-filters-reset").on("click",L),$("#js-input-rating").on("input",function(){$("#js-value-rating").text($(this).val())}),$("#js-input-discount").on("input",function(){const e=$(this).val(),t=$("#js-value-discount");t.text(e>0||t.data("zero")?`\u2265${e}`:`>${e}`)});const D=document.querySelector('input[name="min_release"]');if(D){const e=document.querySelector('input[name="max_release"]');D.value&&e.setAttribute("min",D.value),D.addEventListener("change",function(){e.setAttribute("min",this.value||D.getAttribute("min"))})}$(".steamy-checkbox-control").on("keydown",function(e){e.key==="Enter"&&(e.preventDefault(),$(this).trigger("click"))});const te=document.getElementById("steamdb-extension-protip");te&&te.addEventListener("toast-close",()=>{try{window.sessionStorage.setItem("extension_protip_hidden","1")}catch{}});let m=$("#js-sale-countdown");if(m.length&&m.data("target")){const e=m.data("target");let t=null,s,n,o,a;m=m.find(".sale-timer");const i=function(f,ge){return f+" "+ge+(f==1?"":"s")},c=function(){if(s=e-new Date().getTime(),s<0){clearInterval(t),m.text("Valve time");return}o=0|s%36e5/6e4,a=0|s%6e4/1e3,s>36e5?n=i(0|s/36e5,"hour")+", ":n="",n+=i(o,"minute")+" and "+i(a,"second"),m.text(n)};c(),t=setInterval(c,1e3)}const F=document.getElementById("js-week-button");if(F){const e=document.getElementById("js-week-input");if(e.type!=="week"){if(e.value){const[t,s]=e.value.match(/^([0-9]{4})-?W([0-9]{2})$/).slice(1,3).map(Number),n=new Date(Date.UTC(t,0,4+(3-(new Date(Date.UTC(t,0,4)).getUTCDay()+6)%7))),o=new Date(n);o.setUTCDate(n.getUTCDate()+(s-1)*7-3);const a=o.getUTCFullYear(),i=String(o.getUTCMonth()+1).padStart(2,"0"),c=String(o.getUTCDate()).padStart(2,"0");e.value=`${a}-${i}-${c}`}e.type="date"}e.type==="text"||!("showPicker"in HTMLInputElement.prototype)?F.classList.remove("is-supported"):(e.addEventListener("change",function(){if(!e.checkValidity()||!e.value)return;const t=new URLSearchParams(location.search);if(t.delete("lastweek"),e.type==="week")t.set("week",e.value.replace("-",""));else if(e.type==="date"){const s=new Date(e.value),n=(s.getUTCDay()+6)%7;s.setUTCDate(s.getUTCDate()-n+3);const o=new Date(Date.UTC(s.getUTCFullYear(),0,4)),a=(o.getUTCDay()+6)%7;o.setUTCDate(o.getUTCDate()-a+3);const i=Math.floor((s.getTime()-o.getTime())/(7*24*60*60*1e3))+1,c=s.getUTCFullYear();t.set("week",`${c}W${String(i).padStart(2,"0")}`)}L(),t.sort(),location.href=`/upcoming/?${t}`}),F.addEventListener("click",function(t){t.preventDefault(),e.focus(),e.showPicker()}))}const q=document.querySelector(".table-sales");window.matchMedia("(max-width: 980px)").matches&&q.classList.remove("table-hover");const me=document.getElementById("js-select-type").value;let g=[[0,"desc"],[5,"desc"],[3,"desc"]];const G=[3,5,8];if(U!=="week"&&G.push(6),me==="OwnedGames")g=[[5,"desc"]];else if(U!=="sales"){const e=q.classList.contains("table-display-rank"),t=q.classList.contains("table-display-followers");e?g=[[0,"asc"]]:t?g=[[0,"desc"]]:g=[[5,"desc"],[7,"desc"],[0,"desc"]],t?G.push(0,7,8):G.push(0,7,9)}{const e=new URLSearchParams(location.search).get("sort");if(e){const t=e.split(",");g=[];for(const s of t){const n=s.split("_",2);g.push({name:n[0],dir:n[1]==="asc"?"asc":"desc"})}}}const ne=document.getElementById("js-filter-no-results");let se=ne.hidden,oe=!0;u=$(q).DataTable({columnDefs:[{orderSequence:["desc","asc"],targets:G}],order:g,initComplete(){setTimeout(()=>{r.OnExtensionUserdataLoaded(()=>{fe()}),document.getElementById("js-app").hidden=!1,document.getElementById("js-filter-loader").hidden=!0,u.trigger("column-sizing"),H(),window.removeEventListener("error",_)},5)},drawCallback(){const e=this.api().page.info().recordsDisplay;pe.text(e.toLocaleString());const t=e>0;se!==t&&(se=t,ne.hidden=t),E(),r.HideHoverIfAny()}}).on("order.dt",function(){if(oe){oe=!1;return}const e=u.order(),t=[];for(const o of e){if(!o[1])continue;const a=u.column(o[0]).header();a&&t.push(`${a.dataset.name}_${o[1]}`)}const s=t.join(",");let n=new URLSearchParams(location.search);s?n.set("sort",s):n.delete("sort"),n.sort(),window.history.replaceState(null,null,Array.from(n).length?`${location.pathname}?${n}`:location.pathname),document.querySelectorAll(".js-params-url").forEach(o=>{n=new URLSearchParams(o.search),s?n.set("sort",s):n.delete("sort"),n.sort(),o.search=n.toString()})}).on("page.dt",function(){window.requestAnimationFrame(()=>{document.querySelector(".table-container").scrollIntoView({behavior:"instant",block:"start"})})})})();
