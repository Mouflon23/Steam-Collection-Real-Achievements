(function(){"use strict";function F(e){const t=document.querySelector("#js-filter-loader h3");t.textContent="An error has occured.",t.insertAdjacentText("afterend",e.message),document.querySelector("#js-filter-loader .loader").hidden=!0}function B(){document.getElementById("js-filter-loader").hidden=!1,document.getElementById("js-app").hidden=!0}window.addEventListener("error",F),TimeAgo.cssTooltip=!1,TimeAgo.datetime=function(e){return new Date($(e).attr("data-sort")*1e3)};let d=null;const q=$("#js-select-tags").multipleSelect({placeholder:"Filter by user tags",countSelected:"# of % user tags",filter:!0,onClick(e){const t=$(e),o=t.val();t.prop("checked")?o[0]!=="-"&&t.parent().find(".octicon-diff-added").addClass("tag-on"):(t.parent().find(".tag-on").removeClass("tag-on"),o[0]==="-"&&t.val(o.substring(1)))}}),se=q.data("multipleSelect"),ae=$(`<label class="steamy-checkbox-control"><input type="checkbox" id="js-match-all-tags"${q.data("match")!=="all"?"":" checked"}><span>Match all included tags</span></label>`);se.$drop.find(".ms-search").after(ae);const ie=$("#js-select-categories").multipleSelect({placeholder:"Filter by features",countSelected:"# of % features",filter:!0,onClick(e){const t=$(e),o=t.val();t.prop("checked")?o[0]!=="-"&&t.parent().find(".octicon-diff-added").addClass("tag-on"):(t.parent().find(".tag-on").removeClass("tag-on"),o[0]==="-"&&t.val(o.substring(1)))}});$(".fancy-select").on("click","label .octicon-diff-removed",function(){const e=$(this),t=e.parent().parent(),o=t.find("input"),n=o.val();n[0]!=="-"&&(t.find(".octicon-diff-added").removeClass("tag-on"),e.addClass("tag-on"),o.val("-"+n).prop("checked",!1))});const re=$("#js-select-type").multipleSelect({single:!0}),le=$("#js-select-os").multipleSelect({single:!0}),ce=$("#js-select-cc").multipleSelect({single:!0,filter:!0});let C,_;const de=e=>{const t=document.body.dataset.storeAssets;let o;const n=function(a){a.find(".timeago").each(function(){TimeAgo.init(this)});const i=a[0];let l;i.classList.contains("package")?l=`${t}subs/${i.dataset.subid}/capsule_231x87.jpg?t=${i.dataset.cache}`:l=`${t}apps/${i.dataset.appid}/${i.dataset.capsule}`,a.find(".applogo img").attr("decoding","async").attr("src",l)},s=function(){o=0;const a=(window.innerHeight||document.documentElement.clientHeight)+80,i=[];for(const l of e){const p=l.getBoundingClientRect();p.top>-80&&p.bottom<a&&p.bottom>0&&i.push(l)}for(const l of i)n($(l));e=e.not(i)};_=()=>{clearTimeout(o),s()},C=()=>{o||(o=setTimeout(s,100))},window.addEventListener("scroll",C,{passive:!0}),window.addEventListener("resize",C,{passive:!0})};$(".applogo img").one("error",function(){$(this).attr("src","/static/img/applogo.svg")}),de($(".app, .package"));const ue=$("#js-sales-count"),c=$("#js-filters"),L=c.data("pageType"),E=L==="sales",r=E?"sales":"special",G=document.querySelector(".current-sale-filters-contain"),U=document.querySelector(".current-sale-filters"),H=G.querySelector("#js-remove-svg > svg");H.parentNode.remove(),U.querySelectorAll(".sale-filter > button").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),B();const o=e.dataset.id,n=new URLSearchParams(location.search);E&&(o==="min_discount"||o==="min_rating"||o==="min_reviews")?n.set(o,"0"):n.delete(o),n.sort(),location.search=n.toString()})});function u(e,t,o){if(!o){U.querySelector(`span[data-id="${e}"]`)?.remove(),U.childElementCount===0&&(G.hidden=!0);return}const n=document.createElement("span");n.className="sale-filter",n.dataset.id=e,n.textContent=t;const s=document.createElement("button");s.type="button",s.append(H.cloneNode(!0)),n.append(s),U.append(n),s.addEventListener("click",a=>{a.preventDefault(),document.getElementById(e).click()}),G.hidden=!1}let g;const D=$("#js-wishlisted-only");function N(){u(D.attr("id"),"Wishlisted",g)}D.on("change",function(e){e.stopImmediatePropagation(),g=this.checked,N(),g?window.SteamDB.Storage.Set(r+"-wishlisted-only",1):window.SteamDB.Storage.Remove(r+"-wishlisted-only"),d.draw()});let h;const I=$("#js-followed-only");function W(){u(I.attr("id"),"Followed",h)}I.on("change",function(e){e.stopImmediatePropagation(),h=this.checked,W(),h?window.SteamDB.Storage.Set(r+"-followed-only",1):window.SteamDB.Storage.Remove(r+"-followed-only"),d.draw()});let w;function M(){u(z.attr("id"),"Historical lows",w)}const z=$("#js-discounts-blue").on("change",function(e){e.stopImmediatePropagation(),w=this.checked,M(),w?window.SteamDB.Storage.Set(r+"-blue-discounts-only",1):window.SteamDB.Storage.Remove(r+"-blue-discounts-only"),d.draw()});let S;function Y(){u(V.attr("id"),"Matching lows",S)}const V=$("#js-discounts-green").on("change",function(e){e.stopImmediatePropagation(),S=this.checked,Y(),S?window.SteamDB.Storage.Set(r+"-green-discounts-only",1):window.SteamDB.Storage.Remove(r+"-green-discounts-only"),d.draw()});let y;function J(){u(K.attr("id"),"2-year lows",y)}const K=$("#js-discounts-minor").on("change",function(e){e.stopImmediatePropagation(),y=this.checked,J(),y?window.SteamDB.Storage.Set(r+"-minor-discounts-only",1):window.SteamDB.Storage.Remove(r+"-minor-discounts-only"),d.draw()});let b;const k=$("#js-hide-owned-games");function Q(){u(k.attr("id"),"Hide owned",b)}k.on("change",function(e){e.stopImmediatePropagation(),b=this.checked,Q(),b?window.SteamDB.Storage.Set(r+"-hide-owned-games",1):window.SteamDB.Storage.Remove(r+"-hide-owned-games"),d.draw()});let T;const x=$("#js-hide-ignored-games");function X(){u(x.attr("id"),"Hide ignored",T)}x.on("change",function(e){e.stopImmediatePropagation(),T=this.checked,X(),T?window.SteamDB.Storage.Set(r+"-hide-ignored-games",1):window.SteamDB.Storage.Remove(r+"-hide-ignored-games"),d.draw()});let v;const A=$("#js-hide-wishlisted");function Z(){u(A.attr("id"),"Hide wished and followed",v)}A.on("change",function(e){e.stopImmediatePropagation(),v=this.checked,Z(),v?window.SteamDB.Storage.Set(r+"-hide-wished",1):window.SteamDB.Storage.Remove(r+"-hide-wished"),d.draw()});const pe=()=>{D.removeAttr("disabled").parent().removeClass("tooltipped"),I.removeAttr("disabled").parent().removeClass("tooltipped"),k.removeAttr("disabled").parent().removeClass("tooltipped"),x.removeAttr("disabled").parent().removeClass("tooltipped"),A.removeAttr("disabled").parent().removeClass("tooltipped"),D.length>0&&window.SteamDB.Storage.Get(r+"-wishlisted-only")&&(D.attr("checked",""),g=!0,N()),window.SteamDB.Storage.Get(r+"-followed-only")&&(I.attr("checked",""),h=!0,W()),window.SteamDB.Storage.Get(r+"-hide-ignored-games")&&(x.attr("checked",""),T=!0,X()),window.SteamDB.Storage.Get(r+"-hide-wished")&&(A.attr("checked",""),v=!0,Z()),d.rows(".package").every(function(){let e=!E;const t=this,o=t.node(),n=o.dataset.apps.split(",");delete o.dataset.apps;for(const s of n){const a=Number(s);if(window.SteamDB.FollowedApps.has(a)&&o.classList.add("followed"),window.SteamDB.WishedApps.has(a)&&(o.classList.add("wished"),!e)){e=!0;const i=this.cell(t,0),l=i.node();l.dataset.sort=Number(l.dataset.sort)+9,i.invalidate()}window.SteamDB.IgnoredApps.has(a)&&o.classList.add("ignored")}return!0}),E&&d.rows(".app").every(function(){const e=this,t=e.node(),o=Number(t.dataset.appid);let n=0;if(window.SteamDB.WishedApps.has(o)?t.querySelector(".highest-discount-major")?n=30:t.querySelector(".highest-discount")?n=20:n=10:window.SteamDB.OwnedApps.has(o)&&(n=-5),n!==0){const s=this.cell(e,0),a=s.node();a.dataset.sort=Number(a.dataset.sort)+n,s.invalidate()}return!0}),d.draw()};k.length>0&&window.SteamDB.Storage.Get(r+"-hide-owned-games")&&(k.attr("checked",""),b=!0,Q()),window.SteamDB.Storage.Get(r+"-blue-discounts-only")&&(z.attr("checked",""),w=!0,M()),window.SteamDB.Storage.Get(r+"-green-discounts-only")&&(V.attr("checked",""),S=!0,Y()),window.SteamDB.Storage.Get(r+"-minor-discounts-only")&&(K.attr("checked",""),y=!0,J()),$.fn.dataTableExt.afnFiltering.push(function(e,t,o){const n=e.aoData[o].nTr;if(w||S||y){const s=!!n.querySelector(".price-discount-major"),a=!!n.querySelector(".price-discount-minor"),i=!!n.querySelector(".price-discount"),l=(s?1:0)|(i?2:0)|(a?4:0),p=(w?1:0)|(S?2:0)|(y?4:0);if(!(l&p))return!1}if(g||h||v){const s=n.classList.contains("wished"),a=n.classList.contains("followed");if(v){if(s||a)return!1}else if(!s&&!a||g!==s&&h!==a)return!1}return!(T&&n.classList.contains("ignored")||b&&n.classList.contains("owned"))}),c.on("submit",function(){L!=="sales"&&(c.find("#js-input-discount, #js-input-rating").filter(function(a,i){return i.value===i.min}).prop("disabled",!0),c.find('input[name="min_reviews"]').filter(function(a,i){return i.value<=0}).prop("disabled",!0),c.find('input[name="min_followers"], input[name="max_followers"]').filter(function(a,i){return i.value<=0}).prop("disabled",!0)),c.find('.fancy-price-input, .fancy-date-input, input[name="max_reviews"]').filter(function(a,i){return i.value<=0}).prop("disabled",!0);const e=[ce,re,le];for(const a of e){const i=a.multipleSelect("getSelects");i.length>0&&i[0]!=a.data("default")&&$("<input>").attr({type:"hidden",name:a.attr("name"),value:i[0]}).appendTo(c)}const t=q.prop("disabled",!0).multipleSelect("getSelects");t.length>0&&($("<input>").attr({type:"hidden",name:"tagid",value:t.join(",")}).appendTo(c),$("#js-match-all-tags").is(":checked")||$("<input>").attr({type:"hidden",name:"any_tag",value:"1"}).appendTo(c));const o=ie.prop("disabled",!0).multipleSelect("getSelects");o.length>0&&$("<input>").attr({type:"hidden",name:"category",value:o.join(",")}).appendTo(c),c.find(".fancy-price-input:not(:disabled)").length>0&&c.find("#js-select-cc").prop("disabled",!1);const n=c.find("#js-select-type").val();n!=="Watched"&&n!=="OwnedGames"&&n!=="OwnedGamesDLC"&&n!=="AllOwnedGamesDLC"&&c.find('input[name="accountid"]').prop("disabled",!0);const s=new URLSearchParams(location.search).get("sort");if(s&&$("<input>").attr({type:"hidden",name:"sort",value:s}).appendTo(c),B(),c.serialize().length===0)return window.location.href=window.location.pathname,!1}).find("select, input").one("change",function(){$("#js-filter-submit").prop("disabled",!1)}),$("#js-filters-reset").on("click",B),$("#js-input-rating").on("input",function(){$("#js-value-rating").text($(this).val())}),$("#js-input-discount").on("input",function(){const e=$(this).val(),t=$("#js-value-discount");t.text(e>0||t.data("zero")?`\u2265${e}`:`>${e}`)});const j=document.querySelector('input[name="min_release"]');if(j){const e=document.querySelector('input[name="max_release"]');j.value&&e.setAttribute("min",j.value),j.addEventListener("change",function(){e.setAttribute("min",this.value||j.getAttribute("min"))})}$(".steamy-checkbox-control").on("keydown",function(e){e.key==="Enter"&&(e.preventDefault(),$(this).trigger("click"))});const ee=document.getElementById("steamdb-extension-protip");ee&&ee.addEventListener("toast-close",()=>{try{window.sessionStorage.setItem("extension_protip_hidden","1")}catch{}});let m=$("#js-sale-countdown");if(m.length&&m.data("target")){const e=m.data("target");let t=null,o,n,s,a;m=m.find(".sale-timer");const i=function(p,fe){return p+" "+fe+(p==1?"":"s")},l=function(){if(o=e-new Date().getTime(),o<0){clearInterval(t),m.text("Valve time");return}s=0|o%36e5/6e4,a=0|o%6e4/1e3,o>36e5?n=i(0|o/36e5,"hour")+", ":n="",n+=i(s,"minute")+" and "+i(a,"second"),m.text(n)};l(),t=setInterval(l,1e3)}const P=document.getElementById("js-week-button");if(P){const e=document.getElementById("js-week-input");if(e.type!=="week"){if(e.value){const[t,o]=e.value.match(/^([0-9]{4})-?W([0-9]{2})$/).slice(1,3).map(Number),n=new Date(Date.UTC(t,0,4+(3-(new Date(Date.UTC(t,0,4)).getUTCDay()+6)%7))),s=new Date(n);s.setUTCDate(n.getUTCDate()+(o-1)*7-3);const a=s.getUTCFullYear(),i=String(s.getUTCMonth()+1).padStart(2,"0"),l=String(s.getUTCDate()).padStart(2,"0");e.value=`${a}-${i}-${l}`}e.type="date"}e.type==="text"||!("showPicker"in HTMLInputElement.prototype)?P.classList.remove("is-supported"):(e.addEventListener("change",function(){if(!e.checkValidity()||!e.value)return;const t=new URLSearchParams(location.search);if(t.delete("lastweek"),e.type==="week")t.set("week",e.value.replace("-",""));else if(e.type==="date"){const o=new Date(e.value),n=(o.getUTCDay()+6)%7;o.setUTCDate(o.getUTCDate()-n+3);const s=new Date(Date.UTC(o.getUTCFullYear(),0,4)),a=(s.getUTCDay()+6)%7;s.setUTCDate(s.getUTCDate()-a+3);const i=Math.floor((o.getTime()-s.getTime())/(7*24*60*60*1e3))+1,l=o.getUTCFullYear();t.set("week",`${l}W${String(i).padStart(2,"0")}`)}B(),t.sort(),location.href=`/upcoming/?${t}`}),P.addEventListener("click",function(t){t.preventDefault(),e.focus(),e.showPicker()}))}const O=document.querySelector(".table-sales");window.matchMedia("(max-width: 980px)").matches&&O.classList.remove("table-hover");const me=document.getElementById("js-select-type").value;let f=[[0,"desc"],[5,"desc"],[3,"desc"]];const R=[3,5,8];if(L!=="week"&&R.push(6),me==="OwnedGames")f=[[5,"desc"]];else if(L!=="sales"){const e=O.classList.contains("table-display-rank"),t=O.classList.contains("table-display-followers");e?f=[[0,"asc"]]:t?f=[[0,"desc"]]:f=[[5,"desc"],[7,"desc"],[0,"desc"]],t?R.push(0,7,8):R.push(0,7,9)}{const e=new URLSearchParams(location.search).get("sort");if(e){const t=e.split(",");f=[];for(const o of t){const n=o.split("_",2);f.push({name:n[0],dir:n[1]==="asc"?"asc":"desc"})}}}const te=document.getElementById("js-filter-no-results");let ne=te.hidden,oe=!0;d=$(O).DataTable({columnDefs:[{orderSequence:["desc","asc"],targets:R}],order:f,initComplete(){setTimeout(()=>{window.SteamDB.OnExtensionUserdataLoaded(()=>{pe()}),document.getElementById("js-app").hidden=!1,document.getElementById("js-filter-loader").hidden=!0,d.trigger("column-sizing"),_(),window.removeEventListener("error",F)},5)},drawCallback(){const e=this.api().page.info().recordsDisplay;ue.text(e.toLocaleString());const t=e>0;ne!==t&&(ne=t,te.hidden=t),C(),window.SteamDB.HideHoverIfAny()}}).on("order.dt",function(){if(oe){oe=!1;return}const e=d.order(),t=[];for(const s of e){if(!s[1])continue;const a=d.column(s[0]).header();a&&t.push(`${a.dataset.name}_${s[1]}`)}const o=t.join(",");let n=new URLSearchParams(location.search);o?n.set("sort",o):n.delete("sort"),n.sort(),window.history.replaceState(null,null,Array.from(n).length?`${location.pathname}?${n}`:location.pathname),document.querySelectorAll(".js-params-url").forEach(s=>{n=new URLSearchParams(s.search),o?n.set("sort",o):n.delete("sort"),n.sort(),s.search=n.toString()})}).on("page.dt",function(){window.requestAnimationFrame(()=>{document.querySelector(".table-container").scrollIntoView({behavior:"instant",block:"start"})})})})();
